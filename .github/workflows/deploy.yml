name: Deploy to RUVDS
on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
  - name: Checkout repository
    uses: actions/checkout@v4
  
  - name: Deploy on server
    uses: appleboy/ssh-action@v0.1.10
    with:
      host: ${{ secrets.RUVDS_HOST }}
      username: ${{ secrets.RUVDS_USERNAME }}
      key: ${{ secrets.SSH_PRIVATE_KEY }}
      script: |
        set -e
        
        # Создаем временную папку и клонируем туда нужные файлы
        cd /tmp
        rm -rf cosmochess-deploy
        git clone --depth 1 ${{ github.server_url }}/${{ github.repository }} cosmochess-deploy
        
        # Копируем файлы в рабочую директорию
        mkdir -p /srv/cosmochess
        cp /tmp/cosmochess-deploy/docker-compose.prod.yml /srv/cosmochess/
        cp -r /tmp/cosmochess-deploy/nginx /srv/cosmochess/ 2>/dev/null || true
        
        cd /srv/cosmochess
        
        echo "===> Logging in to GHCR"
        echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
        echo "===> Pulling latest images"
        docker compose -f docker-compose.prod.yml pull
        
        echo "===> Starting containers"
        docker compose -f docker-compose.prod.yml up -d
        
        echo "===> Pruning unused images"
        docker image prune -af
        
        # Очищаем временные файлы
        rm -rf /tmp/cosmochess-deploy            
            echo "===> Pruning unused images"
            docker image prune -af
